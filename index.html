<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HELIOS TERMINAL</title>
    
    <!-- PWA 设置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HELIOS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#213063">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkhFTElPUyBURVJNSU5BTCIsCiAgInNob3J0X25hbWUiOiAiSEVMSU9TIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiCiAgfQ==">

    <!-- 引用外部样式表 -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- ==============================================
         外部系统：主菜单 (LEVEL 1)
         ============================================== -->
    <div id="main-menu-page" class="system-page">
        <div class="sys-top-bar">终端 TERMINAL</div>
        <div class="sys-content-scroll">
            <div class="user-card-container">
                <div class="uc-bg"></div>
                <div class="uc-overlay"></div>
                <div class="uc-content">
                    <img src="" class="uc-avatar" id="uc-avatar-img">
                    <div class="uc-info">
                        <div class="uc-name" id="uc-name-txt">User</div>
                        <div class="uc-id" id="uc-id-txt">@user_id</div>
                        <div class="uc-persona-preview" id="uc-persona-txt">Persona info...</div>
                    </div>
                </div>
                <div class="uc-edit-btn" onclick="openUserEditModal()">✎ 编辑资料</div>
            </div>

            <div class="main-menu-list">
                <div class="menu-item" onclick="goToSubPage('contacts-page')">
                    <img src="https://files.catbox.moe/zvhldm.png" class="menu-deco">
                    <div class="menu-text">通讯录 / CONTACTS</div>
                    <div class="menu-arrow">▶</div>
                </div>
                <div class="menu-item" onclick="goToSubPage('world-page')">
                    <img src="https://files.catbox.moe/zvhldm.png" class="menu-deco">
                    <div class="menu-text">世界书 / WORLD BOOK</div>
                    <div class="menu-arrow">▶</div>
                </div>
                <div class="menu-item" onclick="goToSubPage('api-page')">
                    <img src="https://files.catbox.moe/zvhldm.png" class="menu-deco">
                    <div class="menu-text">API 设置 / CONFIG</div>
                    <div class="menu-arrow">▶</div>
                </div>
                <div class="menu-item" onclick="enterSNS()">
                    <img src="https://files.catbox.moe/zvhldm.png" class="menu-deco">
                    <div class="menu-text">HELIOS∞Channel</div>
                    <div class="menu-arrow" style="color:var(--nav-bg)">●</div>
                </div>
                <div class="menu-item" onclick="enterChatList()">
                    <img src="https://files.catbox.moe/zvhldm.png" class="menu-deco">
                    <div class="menu-text">私信 / DIRECT MSG</div>
                    <div class="menu-arrow">▶</div>
                </div>
            </div>
            
            <div style="text-align:center; margin-top:30px; display:flex; flex-direction:column; gap:10px; align-items:center;">
                <div style="display:flex; gap:10px;">
                    <button class="sys-btn-outline" style="width:auto; padding:8px 15px; font-size:0.8rem;" onclick="exportData()">⬇ 备份数据</button>
                    <button class="sys-btn-outline" style="width:auto; padding:8px 15px; font-size:0.8rem;" onclick="document.getElementById('import-file').click()">⬆ 导入数据</button>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                <button style="background:#888; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:0.75rem;" onclick="clearAllData()">⚠️ 清空所有数据</button>
            </div>
        </div>
    </div>

    <!-- User Edit Modal with Multi-Profile -->
    <div id="user-edit-modal" class="sys-modal hidden">
        <div class="sys-modal-box">
            <div class="sys-modal-header">
                <span>个人资料 & 档案管理</span>
                <span onclick="closeUserEditModal()" style="cursor:pointer;">×</span>
            </div>
            
            <!-- 多档案管理栏 -->
            <div class="profile-manager-bar">
                <select id="profile-select" class="profile-select" onchange="switchProfile(this.value)"></select>
                <button class="profile-btn" onclick="createNewProfile()">+ 新建</button>
                <button class="profile-btn" style="color:red;" onclick="deleteCurrentProfile()">删除</button>
            </div>

            <div class="sys-form-group">
                <label>档案名称 (用于区分)</label>
                <input type="text" id="edit-profile-name" class="sys-input" placeholder="例如：默认马甲">
            </div>

            <div style="border-top:1px solid #eee; margin:10px 0; padding-top:10px;">
                <div class="sys-form-group">
                    <label>昵称</label>
                    <input type="text" id="edit-user-name" class="sys-input">
                </div>
                <div class="sys-form-group">
                    <label>ID</label>
                    <input type="text" id="edit-user-id" class="sys-input">
                </div>
                <div class="sys-form-group">
                    <label>头像 URL</label>
                    <input type="text" id="edit-user-avatar" class="sys-input">
                </div>
                <div class="sys-form-group">
                    <label>设定 (Persona)</label>
                    <textarea id="edit-user-persona" class="sys-textarea" rows="3"></textarea>
                </div>
            </div>
            <button class="sys-btn" onclick="saveUserEdit()">保存所有变更</button>
        </div>
    </div>

    <!-- ==============================================
         外部系统：二级菜单 (LEVEL 2)
         ============================================== -->

    <!-- SUB PAGE: CONTACTS -->
    <div id="contacts-page" class="system-page hidden">
        <div class="sys-top-bar">终端 TERMINAL</div>
        <div class="sub-nav-bar">
            <div class="back-arrow" onclick="backToMenu()">◀</div>
            <div>通讯录</div>
        </div>
        <div class="sys-content-scroll">
            <div class="sub-page-container" id="contacts-list"></div>
        </div>
        <div class="add-btn-float" onclick="addNewRole()">+</div>
    </div>

    <!-- SUB PAGE: WORLD BOOK -->
    <div id="world-page" class="system-page hidden">
        <div class="sys-top-bar">终端 TERMINAL</div>
        <div class="sub-nav-bar">
            <div class="back-arrow" onclick="backToMenu()">◀</div>
            <div>世界书</div>
        </div>
        <div class="sys-content-scroll">
            <div class="sub-page-container">
                <div id="worldbook-list"></div>
                <div class="wb-item" style="border:1px dashed var(--nav-bg); text-align:center; padding:20px; color:var(--nav-bg); cursor:pointer;" onclick="addWorldBookItem()">
                    + 添加世界观条目
                </div>
                <button class="sys-btn" onclick="backToMenu()">保存并返回</button>
            </div>
        </div>
    </div>

    <!-- SUB PAGE: API -->
    <div id="api-page" class="system-page hidden">
        <div class="sys-top-bar">终端 TERMINAL</div>
        <div class="sub-nav-bar">
            <div class="back-arrow" onclick="backToMenu()">◀</div>
            <div>API 设置</div>
        </div>
        <div class="sys-content-scroll">
            <div class="sub-page-container">
                <div class="sys-form-group">
                    <label>API 地址 (Base URL)</label>
                    <input type="text" id="api-url" class="sys-input" value="https://api.openai.com/v1">
                    <small style="color:#666; font-size:0.75rem;">注意：通常以 /v1 结尾</small>
                </div>
                <div class="sys-form-group">
                    <label>API Key</label>
                    <input type="password" id="api-key" class="sys-input" placeholder="sk-...">
                </div>
                <div class="sys-form-group">
                    <label>模型 (Model)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="model-name" class="sys-input" value="gpt-4o-mini">
                        <button class="sys-btn" style="width:auto; margin-top:0; padding:10px;" onclick="fetchModels()">拉取模型</button>
                    </div>
                    <select id="model-select" class="sys-select hidden" onchange="applyModelSelection()" style="margin-top:5px;"></select>
                </div>
                <button class="sys-btn" onclick="saveApiSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- ==============================================
         SNS 系统
         ============================================== -->
    
    <!-- FEED PAGE -->
    <div id="feed-page" class="sns-page hidden">
        <div class="top-nav">
            <div class="nav-left">
                <span class="star-icon" id="fav-filter-btn" onclick="toggleFavFilter()">★</span>
                <img src="" class="avatar" id="nav-avatar-1">
                <div class="user-info">
                    <span class="u-name" id="nav-name-1">USER</span>
                    <span class="u-id" id="nav-id-1">@id</span>
                </div>
            </div>
            <img src="https://files.catbox.moe/gq5aoo.png" class="nav-logo">
        </div>

        <div class="content-scroll-area" id="feed-container"></div>
        <div class="refresh-fab" onclick="generateMultiPosts()">↻</div>
    </div>

    <!-- DETAIL PAGE -->
    <div id="detail-page" class="sns-page hidden">
        <div class="top-nav-p2">
            <div class="nav-left-p2">
                <img src="" class="big-avatar" id="p2-avatar">
                <div class="p2-user-info">
                    <span class="u-name" id="p2-name">Name</span>
                    <span class="u-id" id="p2-id">@id</span>
                </div>
            </div>
            <img src="https://files.catbox.moe/gq5aoo.png" class="nav-logo">
        </div>

        <div class="content-scroll-area">
            <div style="text-align: right; color: #888899; font-size: 0.75rem; margin-bottom: 5px; padding-right: 5px;" id="detail-time-display">Time</div>

            <div class="sns-card">
                <div class="card-media" id="card-media"></div>
                <div class="card-body" id="card-body">Content</div>
            </div>

            <div class="footer-icons" style="margin-top: 10px; padding-left: 5px; margin-bottom: 20px;">
                <span id="detail-heart-btn" onclick="toggleLikeCurrent()">♥</span>
                <span id="detail-star-btn" onclick="toggleFavCurrent()">★</span>
                <span class="action-dots" onclick="openActionMenu('post', currentPostId, -1)">···</span>
            </div>

            <div class="page2-btn-container">
                <div class="generating-status" id="detail-gen-status"></div>
                <div class="skew-btn" onclick="openReplyModal()">
                    <span>写写评论…</span>
                </div>
            </div>

            <div id="comments-container"></div>
            <div class="more-comments-btn" onclick="summonBatchComments()">⟳ 召唤新评论 (AI)</div>
        </div>
    </div>

    <!-- BOTTOM NAV (SNS Only) -->
    <div class="bottom-nav hidden" id="bottom-bar">
        <div class="skew-btn btn-post-nav" id="btn-post-trigger" onclick="openUserPostModal()">
            <span>✏️ POST</span>
        </div>
        <div class="skew-btn btn-back-nav hidden" id="btn-back-trigger" onclick="goBack()">
            <span>◀ BACK</span>
        </div>
        <div class="btn-close" onclick="exitSNS()">×</div>
    </div>

    <!-- ==============================================
         CHAT 系统 (修订版)
         ============================================== -->

    <!-- 1. 消息列表页 (CHAT LIST) -->
    <div id="chat-list-page" class="system-page hidden">
        <div class="sys-top-bar" style="justify-content: space-between; padding: 0 15px;">
            <div class="back-arrow" onclick="backToMenu()">◀</div>
            <span>消息 MESSAGES</span>
            <div style="font-size:1.5rem; cursor:pointer;" onclick="openNewChatModal()">+</div>
        </div>
        <div class="sys-content-scroll">
            <div id="chat-list-container" class="sub-page-container" style="padding:0;">
                <!-- JS 将在这里生成聊天列表项 -->
                <div class="empty-tip">暂无会话，点击右上角 + 创建</div>
            </div>
        </div>
    </div>

    <!-- 2. 聊天窗口页 (CHAT ROOM) - [FIXED] -->
    <div id="chat-room-page" class="system-page hidden" style="background: #e6ebf0;">
        <!-- 顶部导航 [已修复：添加状态栏] -->
        <div class="sys-top-bar" style="justify-content: space-between; padding: 0 10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="back-arrow" onclick="exitChatRoom()">◀</div>
                <div style="display:flex; flex-direction:column; line-height:1.2;">
                    <span id="chat-title-name" style="font-weight:bold;">Role Name</span>
                    <span id="chat-title-status" style="font-size:0.7rem; color:rgba(255,255,255,0.7);"></span>
                </div>
            </div>
            <div style="font-size:1.2rem; cursor:pointer;" onclick="toggleChatSidebar()">☰</div>
        </div>

        <!-- 聊天记录滚动区 -->
        <div class="chat-msg-container" id="chat-msg-container">
            <!-- JS 填充消息气泡 -->
        </div>

        <!-- 底部输入区域容器 -->
        <div class="chat-footer-area">
            
            <!-- 表情包面板 (默认隐藏) -->
            <div id="sticker-panel" class="sticker-panel hidden">
                <div class="sticker-header">
                    <span>已存表情</span>
                    <button class="sys-btn-outline" style="width:auto; padding:2px 8px; font-size:0.75rem;" onclick="document.getElementById('sticker-upload').click()">+ 上传</button>
                    <input type="file" id="sticker-upload" class="hidden" accept="image/*" onchange="handleStickerUpload(this)">
                </div>
                <div class="sticker-grid" id="sticker-grid">
                    <!-- JS 填充表情 -->
                </div>
            </div>

            <!-- <!-- 工具栏 (输入框上方) -->
<div class="chat-toolbar">
    <!-- 直接放图标，CSS会把它排在左边并加间距 -->
    <img src="https://files.catbox.moe/1poupw.png" class="tool-icon" id="sticker-toggle-btn" onclick="toggleStickerPanel(event)">
</div>

            <!-- 输入行 -->
            <div class="chat-input-row">
                <!-- 生成键 (左) -->
                <div class="chat-action-btn gen-btn" onclick="triggerChatGen()">
                    <img src="https://files.catbox.moe/prdem6.png">
                </div>
                
                <textarea id="chat-input" class="chat-textarea" rows="1" placeholder="发送消息..."></textarea>
                
                <!-- 发送键 (右) -->
                <div class="chat-action-btn send-btn" onclick="sendUserMessage()">
                    <img src="https://files.catbox.moe/4s5ch3.png">
                </div>
            </div>
        </div>

        <!-- 侧边菜单栏 (遮罩 + 面板) [已修复：添加总结控件] -->
        <div id="chat-sidebar-overlay" class="chat-sidebar-overlay hidden" onclick="toggleChatSidebar()"></div>
        <div id="chat-sidebar" class="chat-sidebar">
            <div class="sidebar-header">聊天设置</div>
            <div class="sidebar-content">
                
                <div class="sidebar-item">
                    <label>🎭 当前身份 (User)</label>
                    <select id="chat-user-select" class="sys-select"></select>
                </div>

                <div class="sidebar-item">
                    <label>🌍 世界书</label>
                    <select id="chat-world-select" class="sys-select">
                        <option value="off">不启用</option>
                        <!-- JS 填充 -->
                    </select>
                </div>

                <!-- 新增：长期记忆/总结设置 -->
                <div class="sidebar-item" style="border-top:1px dashed #ddd; padding-top:10px; margin-top:10px;">
                    <label>🧠 长期记忆 (AI 自动总结)</label>
                    <div style="display:flex; gap:10px;">
                        <select id="chat-summary-toggle" class="sys-select">
                            <option value="off">关闭</option>
                            <option value="on">开启</option>
                        </select>
                        <input type="number" id="chat-summary-interval" class="sys-input" placeholder="轮数" value="10" title="每隔多少轮对话触发总结">
                    </div>
                    <textarea id="chat-summary-content" class="sys-textarea" rows="4" placeholder="这里是AI生成的长期记忆摘要..." style="margin-top:5px; font-size:0.8rem; color:#666;"></textarea>
                    <button class="sys-btn" style="margin-top:5px; padding:5px; font-size:0.8rem;" onclick="saveChatSummaryManually()">手动保存记忆文本</button>
                </div>

                <div class="sidebar-item" style="border-top:1px dashed #ddd; padding-top:10px;">
                    <label>🖼️ 聊天背景</label>
                    <input type="text" id="chat-bg-input" class="sys-input" placeholder="图片URL">
                    <button class="sys-btn" style="margin-top:5px; padding:5px;" onclick="saveChatBg()">应用</button>
                </div>

                <div class="sidebar-item">
                    <label>📜 历史记录加载数</label>
                    <input type="number" id="chat-history-limit" class="sys-input" value="20">
                </div>

                <div class="sidebar-item" style="margin-top:auto; padding-top:20px; border-top:1px solid #eee;">
                    <button class="sys-btn sys-btn-danger" onclick="clearChatHistory()">🗑️ 清空聊天记录</button>
                </div>

            </div>
        </div>
    </div>
    
    <!-- SNS MODALS -->
    
    <!-- [已修复：新增聊天列表长按菜单] -->
    <div id="chat-list-menu-modal" class="modal-overlay hidden" onclick="closeChatListMenu()">
        <div class="reply-box" onclick="event.stopPropagation()">
            <h3>会话操作</h3>
            <div class="action-menu-item" onclick="toggleChatPin()">📌 置顶 / 取消置顶</div>
            <div class="action-menu-item danger" onclick="deleteChatSession()">🗑️ 删除会话</div>
            <div class="action-menu-item" onclick="closeChatListMenu()">取消</div>
        </div>
    </div>

    <div id="reply-modal" class="modal-overlay hidden">
        <div class="reply-box">
            <h3>✉️ 发送评论</h3>
            <label style="font-size:0.8rem; color:#666;">回复给：</label>
            <select id="reply-target-select" class="reply-target-select"></select>
            <textarea id="reply-text" class="reply-textarea" placeholder="输入你的评论..."></textarea>
            <div class="reply-actions">
                <button class="btn-cancel" onclick="closeReplyModal()">取消</button>
                <button class="btn-send" onclick="submitReply()">发送</button>
            </div>
        </div>
    </div>

    <div id="user-post-modal" class="modal-overlay hidden">
        <div class="reply-box">
            <h3>✏️ 发布新动态</h3>
            <div class="sys-form-group">
                <label>配图 URL (可选)</label>
                <input type="text" id="upost-img" class="sys-input" placeholder="https://...">
            </div>
            <div class="sys-form-group">
                <label>图片描述 (可选)</label>
                <input type="text" id="upost-desc" class="sys-input" placeholder="例如：一只橘色的猫咪...">
            </div>
            <div class="sys-form-group">
                <label>正文内容</label>
                <textarea id="upost-text" class="reply-textarea" rows="3" placeholder="分享你的想法..."></textarea>
            </div>
            <div class="reply-actions">
                <button class="btn-cancel" onclick="closeUserPostModal()">取消</button>
                <button class="btn-send" onclick="submitUserPost()">发布</button>
            </div>
        </div>
    </div>

    <div id="action-menu-modal" class="modal-overlay hidden" onclick="closeActionMenu()">
        <div class="reply-box" onclick="event.stopPropagation()">
            <div class="action-menu-item" onclick="handleEditAction()">✏️ 编辑内容</div>
            <div class="action-menu-item danger" onclick="handleDeleteAction()">🗑️ 删除</div>
            <div class="action-menu-item" onclick="closeActionMenu()">取消</div>
        </div>
    </div>

    <div id="edit-content-modal" class="modal-overlay hidden">
        <div class="reply-box">
            <h3>✎ 编辑内容</h3>
            <textarea id="edit-text-input" class="reply-textarea" rows="4"></textarea>
            <div class="reply-actions">
                <button class="btn-cancel" onclick="closeEditModal()">取消</button>
                <button class="btn-send" onclick="saveEditContent()">保存修改</button>
            </div>
        </div>
    </div>

    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <div>生成中，请稍后…</div>
    </div>

    <!-- 顺序加载 JS 文件 -->
    <script src="data.js"></script>
    <script src="sns.js"></script>
    <script src="chat.js"></script>
    
     <!-- CHAT MODALS -->
    
    <!-- 新建聊天选择角色 -->
    <!-- search: <!-- CHAT MODALS --> -->
<!-- search: <!-- 新建聊天选择角色 --> -->

    <!-- [新增] 消息长按操作菜单 -->
    <div id="msg-menu-modal" class="modal-overlay hidden" onclick="closeMsgMenu()">
        <div class="reply-box" onclick="event.stopPropagation()">
            <h3 style="margin-bottom:10px;">消息操作</h3>
            <div class="action-menu-item danger" onclick="confirmDeleteMsg()">🗑️ 删除此条消息</div>
            <div class="action-menu-item" onclick="closeMsgMenu()">取消</div>
        </div>
    </div>

    <div id="new-chat-modal" class="modal-overlay hidden">
        <div class="reply-box">
            <h3>💬 发起新私聊</h3>
            <div class="sys-form-group">
                <label>选择通讯录角色</label>
                <select id="new-chat-role-select" class="sys-select"></select>
            </div>
            <div class="reply-actions">
                <button class="btn-cancel" onclick="closeNewChatModal()">取消</button>
                <button class="btn-send" onclick="createNewChat()">创建</button>
            </div>
        </div>
    </div>

    <!-- 表情包描述填写弹窗 -->
    <div id="sticker-desc-modal" class="modal-overlay hidden">
        <div class="reply-box">
            <h3>😊 添加表情包</h3>
            <div style="text-align:center; margin-bottom:10px;">
                <img id="sticker-preview-img" src="" style="max-height:100px; border-radius:4px;">
            </div>
            <div class="sys-form-group">
                <label>表情描述 (Prompt)</label>
                <input type="text" id="sticker-desc-input" class="sys-input" placeholder="例如：惊讶，大哭...">
                <small style="color:#666;">AI 将“看”到这段文字</small>
            </div>
            <div class="reply-actions">
                <button class="btn-cancel" onclick="document.getElementById('sticker-desc-modal').classList.add('hidden')">取消</button>
                <button class="btn-send" onclick="confirmStickerUpload()">确认添加</button>
            </div>
        </div>
    </div>
</body>
</html>